<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - URL Shortener</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://unpkg.com/preact@latest/dist/preact.min.js"></script>
    <script src="https://unpkg.com/htm@latest/dist/htm.js"></script>
</head>
<body>
    <main class="container">
        <div id="app"></div>
    </main>

    <script type="module">
        const { h, Component, render } = preact;
        const html = htm.bind(h);

        class AdminApp extends Component {
            state = {
                routes: [],
                loading: true,
                showForm: false,
                editingCode: null,
                formData: {
                    url: '',
                    code: '',
                    expiry: '1d'
                }
            };

            async componentDidMount() {
                await this.loadRoutes();
            }

            async loadRoutes() {
                try {
                    const response = await fetch('/api/admin/routes');
                    if (!response.ok) {
                        if (response.status === 401) {
                            window.location.href = '/auth/google';
                            return;
                        }
                        throw new Error('Failed to load routes');
                    }
                    const routes = await response.json();
                    this.setState({ routes, loading: false });
                } catch (error) {
                    console.error(error);
                    this.setState({ loading: false });
                }
            }

            async createRoute(e) {
                e.preventDefault();
                const { formData } = this.state;
                
                try {
                    const response = await fetch('/api/admin/routes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        alert('Error: ' + error);
                        return;
                    }

                    this.setState({
                        showForm: false,
                        formData: { url: '', code: '', expiry: '1d' }
                    });
                    await this.loadRoutes();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            async updateRoute(code) {
                const { formData } = this.state;
                
                try {
                    const response = await fetch(`/api/admin/routes/${code}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    if (!response.ok) {
                        const error = await response.text();
                        alert('Error: ' + error);
                        return;
                    }

                    this.setState({
                        editingCode: null,
                        formData: { url: '', code: '', expiry: '1d' }
                    });
                    await this.loadRoutes();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            async deleteRoute(code) {
                if (!confirm('Are you sure you want to delete this route?')) {
                    return;
                }

                try {
                    const response = await fetch(`/api/admin/routes/${code}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error('Failed to delete route');
                    }

                    await this.loadRoutes();
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }

            startEdit(route) {
                this.setState({
                    editingCode: route.code,
                    formData: {
                        url: route.url,
                        code: route.code,
                        expiry: this.getExpiryType(route.expires_at)
                    }
                });
            }

            getExpiryType(expiresAt) {
                const now = new Date();
                const expires = new Date(expiresAt);
                const days = Math.round((expires - now) / (1000 * 60 * 60 * 24));
                
                if (days <= 1) return '1d';
                if (days <= 7) return '7d';
                if (days <= 30) return '30d';
                return 'perma';
            }

            formatDate(dateString) {
                return new Date(dateString).toLocaleString();
            }

            render() {
                const { routes, loading, showForm, editingCode, formData } = this.state;

                if (loading) {
                    return html`<p aria-busy="true">Loading...</p>`;
                }

                return html`
                    <div>
                        <header>
                            <h1>Admin Dashboard</h1>
                            <nav>
                                <ul>
                                    <li><a href="/" role="button">Home</a></li>
                                    <li><a href="/auth/logout" role="button" class="secondary">Logout</a></li>
                                </ul>
                            </nav>
                        </header>

                        <article>
                            <header>
                                <h2>Routes</h2>
                                <button onClick=${() => this.setState({ showForm: !showForm })}>
                                    ${showForm ? 'Cancel' : 'Create New'}
                                </button>
                            </header>

                            ${showForm && html`
                                <form onSubmit=${(e) => this.createRoute(e)}>
                                    <label>
                                        URL
                                        <input 
                                            type="url" 
                                            value=${formData.url}
                                            onInput=${(e) => this.setState({
                                                formData: { ...formData, url: e.target.value }
                                            })}
                                            required
                                        />
                                    </label>
                                    <label>
                                        Custom Code (optional)
                                        <input 
                                            type="text" 
                                            value=${formData.code}
                                            onInput=${(e) => this.setState({
                                                formData: { ...formData, code: e.target.value }
                                            })}
                                        />
                                    </label>
                                    <label>
                                        Expiry
                                        <select 
                                            value=${formData.expiry}
                                            onChange=${(e) => this.setState({
                                                formData: { ...formData, expiry: e.target.value }
                                            })}
                                        >
                                            <option value="1d">1 Day</option>
                                            <option value="7d">7 Days</option>
                                            <option value="30d">30 Days</option>
                                            <option value="perma">Permanent</option>
                                        </select>
                                    </label>
                                    <button type="submit">Create</button>
                                </form>
                            `}

                            <table>
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>URL</th>
                                        <th>Uses</th>
                                        <th>Last Access</th>
                                        <th>Expires</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${routes.map(route => html`
                                        <tr key=${route.code}>
                                            <td>
                                                <a href="/${route.code}" target="_blank">
                                                    /${route.code}
                                                </a>
                                            </td>
                                            <td>
                                                ${editingCode === route.code ? html`
                                                    <input 
                                                        type="url" 
                                                        value=${formData.url}
                                                        onInput=${(e) => this.setState({
                                                            formData: { ...formData, url: e.target.value }
                                                        })}
                                                    />
                                                ` : html`
                                                    <small>${route.url}</small>
                                                `}
                                            </td>
                                            <td>${route.uses || 0}</td>
                                            <td>
                                                <small>
                                                    ${route.last_access ? this.formatDate(route.last_access) : 'Never'}
                                                </small>
                                            </td>
                                            <td>
                                                ${editingCode === route.code ? html`
                                                    <select 
                                                        value=${formData.expiry}
                                                        onChange=${(e) => this.setState({
                                                            formData: { ...formData, expiry: e.target.value }
                                                        })}
                                                    >
                                                        <option value="1d">1 Day</option>
                                                        <option value="7d">7 Days</option>
                                                        <option value="30d">30 Days</option>
                                                        <option value="perma">Permanent</option>
                                                    </select>
                                                ` : html`
                                                    <small>${this.formatDate(route.expires_at)}</small>
                                                `}
                                            </td>
                                            <td>
                                                ${editingCode === route.code ? html`
                                                    <button 
                                                        class="secondary"
                                                        onClick=${() => this.updateRoute(route.code)}
                                                    >
                                                        Save
                                                    </button>
                                                    <button 
                                                        class="secondary"
                                                        onClick=${() => this.setState({ 
                                                            editingCode: null,
                                                            formData: { url: '', code: '', expiry: '1d' }
                                                        })}
                                                    >
                                                        Cancel
                                                    </button>
                                                ` : html`
                                                    <button 
                                                        class="secondary"
                                                        onClick=${() => this.startEdit(route)}
                                                    >
                                                        Edit
                                                    </button>
                                                    <button 
                                                        class="contrast"
                                                        onClick=${() => this.deleteRoute(route.code)}
                                                    >
                                                        Delete
                                                    </button>
                                                `}
                                            </td>
                                        </tr>
                                    `)}
                                </tbody>
                            </table>
                        </article>
                    </div>
                `;
            }
        }

        render(html`<${AdminApp} />`, document.getElementById('app'));
    </script>
</body>
</html>
